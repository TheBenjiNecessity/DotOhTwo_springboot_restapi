version: 0.2

variables: &aws-constants
    REPOSITORY_URI: "045163258667.dkr.ecr.us-east-1.amazonaws.com/dotohtwo-api"
    AWS_DEFAULT_REGION: "us-east-1"

phases:
    install:
        runtime-versions:
            docker: 18

    pre_build:
        commands:
            - echo Logging in to Amazon ECR...
            - aws --version
            - $(aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $REPOSITORY_URI)

    build:
        commands:
            - echo Build started on `date`
            - docker build -t $REPOSITORY_URI:$CODEBUILD_RESOLVED_SOURCE_VERSION .
            - docker tag $REPOSITORY_URI:$CODEBUILD_RESOLVED_SOURCE_VERSION $REPOSITORY_URI:latest

    post_build:
        commands:
            - echo Build completed on `date`
            - echo Pushing the Docker images...
            - docker push $REPOSITORY_URI:$CODEBUILD_RESOLVED_SOURCE_VERSION
            - docker push $REPOSITORY_URI:latest
